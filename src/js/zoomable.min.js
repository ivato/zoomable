(function(i){i.fn["zoomable"]=function(n){var t=["Width","Height"],e;while(e=t.pop()){(function(n,t){i.fn[n]=n in new Image?function(){return this[0][n]}:function(){var i=this[0],n,e;if(i.tagName.toLowerCase()==="img"){n=new Image;n.src=i.src,e=n[t]}return e}})("natural"+e,e.toLowerCase())}var o=i(this),a=o.smallImage=o.find("img").first();o.options=i.extend({cssPrefix:"zoomable-",animated:true,animDuration:200,unzoomClickDelay:150,maxThumbnailSize:200,fadeOnLoad:.5,thumbnail:true},n);o.options.zoomInCursor&&a.css("cursor",o.options.zoomInCursor);var s="mouseup touchend",h="mousedown touchstart",r="mousemove touchmove";o.zoomed=false;o["moveTo"]=function(i,n){if(o.bigImage){var t=n.complete;var e=n.step;n.complete=function(){o.options.thumbnail&&o.updateLens();t&&t(o)};if(o.options.thumbnail){n.step=function(){o.updateLens();e&&step(o)}}o.bigImage.animate({left:Math.max(o.cSize.w-o.sizeBig.w,Math.min(0,-i.x)),top:Math.max(o.cSize.h-o.sizeBig.h,Math.min(0,-i.y))},n)}};o["getPosition"]=function(){var i=o.bigImage?o.bigImage.position():{left:0,top:0};return{left:i.left*-1,top:i.top*-1}};o["getSize"]=function(){return o.sizeBig?{width:o.sizeBig.w,height:o.sizeBig.h}:{width:0,height:0}};o["unzoom"]=function(i){if(o.zoomed){var n=function(){o.zoomed=false;o.bigImage.unbind(h).remove();o.options.thumbnail&&o.thumbnail.unbind(r).unbind(s).unbind(h).remove();o.smallImage.css("visibility","visible");i&&typeof i==="function"&&i(o);o.options.onUnzoomDidEnd&&o.options.onUnzoomDidEnd(o)};o.thumbnail.css("visibility","hidden").empty();if(o.options.animated){o.bigImageContent.animate({width:o.sizeInt.w,height:o.sizeInt.h},o.options.animDuration);o.bigImage.animate({left:(o.cSize.w-o.sizeInt.w)/2,top:(o.cSize.h-o.sizeInt.h)/2},o.options.animDuration,n)}else{n()}o.options.onUnzoomDidStart&&o.options.onUnzoomDidStart(o)}};o["zoom"]=function(n,t){if(o.zoomed)return;o.zoomed=true;var e=o.cSize={w:o.width(),h:o.height()},m=o.options.url,p=o.bigImage=i('<div class="'+o.options.cssPrefix+"image "+o.options.cssPrefix+'big"></div>'),u=o.thumbnail=i('<div class="'+o.options.cssPrefix+'zoomnav" ></div>');if(o.options.thumbnail)u.appendTo(o);p.appendTo(o);p.css("visibility","hidden");o.options.fadeOnLoad>=0&&a.css("opacity",o.options.fadeOnLoad);var c=n?{x:n.offsetX||n.x||n.clientX,y:n.offsetY||n.x||n.clientY}:false,d={x:0,y:0};bigImageContent=o.bigImageContent=i('<img src="'+m+'" >'),spinner=i('<div class="'+o.options.cssPrefix+'spinner" ></div>');spinner.appendTo(o);o.bigImageContent.appendTo(p);o.options.onZoomDidStart&&o.options.onZoomDidStart(o);bigImageContent.load(function(n){spinner.remove();t&&t.onLoadComplete&&t.onLoadComplete(o);o.options.onLoadComplete&&o.options.onLoadComplete(o);p.css("visibility","visible");a.css({visibility:"hidden",opacity:1});var l=o.sizeBig={w:bigImageContent.naturalWidth(),h:bigImageContent.naturalHeight()};var f=l.w/l.h;var g=o.sizeInt=f>1?{w:e.w,h:l.h/l.w*e.w}:{w:l.w/l.h*e.h,h:e.h};if(!c)c={x:e.w/2,y:e.h/2};var v={x:Math.max(0,Math.min(1,(c.x-(e.w-g.w)/2)/g.w)),y:Math.max(0,Math.min(1,(c.y-(e.h-g.h)/2)/g.h))};p.css({width:l.w,height:l.h});var w=function(){if(o.options.thumbnail){var n=parseFloat(u.css("max-width"))||200,a=i('<img src="'+m+'"" >');a.appendTo(u);var c=i('<div class="'+o.options.cssPrefix+'zoomnav-lens" ></div>');c.appendTo(u);n=o.options.maxThumbnailSize;var f=g.w>g.h?{w:n,h:g.h/g.w*n}:{w:g.w/g.h*n,h:n},v={w:e.w/l.w*f.w,h:e.h/l.h*f.h};a.width(f.w).height(f.h);u.css({visibility:"visible",width:f.w,height:f.h});c.css({width:v.w,height:v.h});o.updateLens=function(){var i=p.position();c.css({left:-i.left/l.w*f.w,top:-i.top/l.h*f.h})};o.updateLens();var w=function(){var i=c.position();p.css({left:-i.left*l.w/f.w,top:-i.top*l.h/f.h})};u.bind(h,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];var n=o.offset();var t=i.pageX-n.left;var e=i.pageY-n.top;c.css({left:Math.min(f.w-v.w,Math.max(0,t-v.w/2)),top:Math.min(f.h-v.h,Math.max(0,e-v.h/2))});w();d={x:i.screenX,y:i.screenY};u.bind(s,function(i){u.unbind(r).unbind(s);return false});u.bind(r,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];if(i.which==0)return false;var n={x:i.screenX-d.x,y:i.screenY-d.y};d.x=i.screenX;d.y=i.screenY;var t={left:Math.min(f.w-v.w,Math.max(0,c.position().left+n.x)),top:Math.min(f.h-v.h,Math.max(0,c.position().top+n.y))};c.css(t);w();return false});return false})}p.bind(h,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];var n=(new Date).getTime();d={x:i.screenX,y:i.screenY};o.bind(s,function(i){o.unbind(r).unbind(s);if((new Date).getTime()-n<o.options.unzoomClickDelay){o["unzoom"]()}return false});o.bind(r,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];if(i.type=="mousemove"&&i.which!=1)return false;var n={x:i.screenX-d.x,y:i.screenY-d.y};d.x=i.screenX;d.y=i.screenY;var t={left:Math.max(-l.w+e.w,Math.min(0,p.position().left+n.x)),top:Math.max(-l.h+e.h,Math.min(0,p.position().top+n.y))};p.css(t);o.options.onMove&&o.options.onMove(o);o.options.thumbnail&&o.updateLens();return false});return false});t&&t.onZoomDidEnd&&t.onZoomDidEnd(o);o.options.onZoomDidEnd&&o.options.onZoomDidEnd(o)};if(o.options.animated){p.css({left:(e.w-g.w)/2,top:(e.h-g.h)/2});bigImageContent.css({width:g.w,height:g.h});bigImageContent.animate({width:l.w,height:l.h},o.options.animDuration);p.animate({left:-v.x*(l.w-e.w)+"px",top:-v.y*(l.h-e.h)+"px"},o.options.animDuration,w)}else{p.css({left:-v.x*(l.w-e.w)+"px",top:-v.y*(l.h-e.h)+"px"});w()}})};a.bind("mouseup",o["zoom"]);return o}})(jQuery);
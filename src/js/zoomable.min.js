(function(i){i.fn.zoomable=function(n){var t=i(this),e=t.smallImage=t.find("img").first();t.options=i.extend({cssPrefix:"zoomable-",animated:true,animDuration:200,dblclickDelay:150,maxThumbnailSize:200,fadeOnLoad:.5,thumbnail:true},n);t.options.zoomInCursor&&e.css("cursor",t.options.zoomInCursor);var o="mouseup touchend",a="mousedown touchstart",s="mousemove touchmove";t.zoomed=false;t["moveTo"]=function(i,n){if(t.bigImage){var e=n.complete;var o=n.step;n.complete=function(){t.options.thumbnail&&t.updateLens();e&&e(t)};if(t.options.thumbnail){n.step=function(){t.updateLens();o&&step(t)}}t.bigImage.animate({left:Math.max(t.cSize.w-t.sizeBig.w,Math.min(0,-i.x)),top:Math.max(t.cSize.h-t.sizeBig.h,Math.min(0,-i.y))},n)}};t["getPosition"]=function(){var i=t.bigImage?t.bigImage.position():{left:0,top:0};return{left:i.left*-1,top:i.top*-1}};t["getSize"]=function(){return t.sizeBig?{width:t.sizeBig.w,height:t.sizeBig.h}:{width:0,height:0}};t["unzoom"]=function(i){if(t.zoomed){var n=function(){t.zoomed=false;t.bigImage.unbind(a).remove();t.options.thumbnail&&t.thumbnail.unbind(s).unbind(o).unbind(a).remove();t.smallImage.css("visibility","visible");t.options.onUnzoomDidEnd&&t.options.onUnzoomDidEnd(t)};t.thumbnail.css("visibility","hidden").empty();if(t.options.animated){t.bigImageContent.animate({width:t.sizeInt.w,height:t.sizeInt.h},t.options.animDuration);t.bigImage.animate({left:(t.cSize.w-t.sizeInt.w)/2,top:(t.cSize.h-t.sizeInt.h)/2},t.options.animDuration,n)}else{n()}t.options.onUnzoomDidStart&&t.options.onUnzoomDidStart(t)}};t["zoom"]=function(n){if(t.zoomed)return;t.zoomed=true;var h=t.cSize={w:t.width(),h:t.height()},r=t.options.url,m=t.bigImage=i('<div class="'+t.options.cssPrefix+"image "+t.options.cssPrefix+'big"></div>'),c=t.thumbnail=i('<div class="'+t.options.cssPrefix+'zoomnav" ></div>');if(t.options.thumbnail)c.appendTo(t);m.appendTo(t);m.css("visibility","hidden");t.options.fadeOnLoad>=0&&e.css("opacity",t.options.fadeOnLoad);var p=n?{x:n.offsetX||n.x||n.clientX,y:n.offsetY||n.x||n.clientY}:false,l={x:0,y:0};bigImageContent=t.bigImageContent=i('<img src="'+r+'"" >'),spinner=i('<div class="'+t.options.cssPrefix+'spinner" ></div>');t.bigImageContent.appendTo(m);t.options.onZoomDidStart&&t.options.onZoomDidStart(t);bigImageContent.load(function(n){spinner.remove();m.css("visibility","visible");e.css({visibility:"hidden",opacity:1});var u=t.sizeBig={w:(n.srcElement||n.target).clientWidth,h:(n.srcElement||n.target).clientHeight};var d=u.w/u.h;var f=t.sizeInt=d>1?{w:h.w,h:u.h/u.w*h.w}:{w:u.w/u.h*h.h,h:h.h};if(!p)p={x:h.w/2,y:h.h/2};var g={x:Math.max(0,Math.min(1,(p.x-(h.w-f.w)/2)/f.w)),y:Math.max(0,Math.min(1,(p.y-(h.h-f.h)/2)/f.h))};m.css({width:u.w,height:u.h});var v=function(){if(t.options.thumbnail){var n=parseFloat(c.css("max-width"))||200,e=i('<img src="'+r+'"" >');e.appendTo(c);var p=i('<div class="'+t.options.cssPrefix+'lens"></div>');p.appendTo(c);n=t.options.maxThumbnailSize;var d=f.w>f.h?{w:n,h:f.h/f.w*n}:{w:f.w/f.h*n,h:n},g={w:h.w/u.w*d.w,h:h.h/u.h*d.h};e.width(d.w).height(d.h);c.css({visibility:"visible",width:d.w,height:d.h});p.css({width:g.w,height:g.h});t.updateLens=function(){var i=m.position();p.css({left:-i.left/u.w*d.w,top:-i.top/u.h*d.h})};t.updateLens();var v=function(){var i=p.position();m.css({left:-i.left*u.w/d.w,top:-i.top*u.h/d.h})};c.bind(a,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];var n=t.offset();var e=i.pageX-n.left;var a=i.pageY-n.top;p.css({left:Math.min(d.w-g.w,Math.max(0,e-g.w/2)),top:Math.min(d.h-g.h,Math.max(0,a-g.h/2))});v();l={x:i.screenX,y:i.screenY};c.bind(o,function(i){c.unbind(s).unbind(o);return false});c.bind(s,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];if(i.which==0)return false;var n={x:i.screenX-l.x,y:i.screenY-l.y};l.x=i.screenX;l.y=i.screenY;var t={left:Math.min(d.w-g.w,Math.max(0,p.position().left+n.x)),top:Math.min(d.h-g.h,Math.max(0,p.position().top+n.y))};p.css(t);v();return false});return false})}m.bind(a,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];var n=(new Date).getTime();l={x:i.screenX,y:i.screenY};t.bind(o,function(i){t.unbind(s).unbind(o);if((new Date).getTime()-n<t.options.dblclickDelay){t["unzoom"]()}return false});t.bind(s,function(i){i.preventDefault();if(i.originalEvent&&i.originalEvent.changedTouches)i=i.originalEvent.changedTouches[0];if(i.type=="mousemove"&&i.which!=1)return false;var n={x:i.screenX-l.x,y:i.screenY-l.y};l.x=i.screenX;l.y=i.screenY;var e={left:Math.max(-u.w+h.w,Math.min(0,m.position().left+n.x)),top:Math.max(-u.h+h.h,Math.min(0,m.position().top+n.y))};m.css(e);t.options.onMove&&t.options.onMove(t);t.options.thumbnail&&t.updateLens();return false});return false})};t.options.onZoomDidEnd&&t.options.onZoomDidEnd(t);if(t.options.animated){m.css({left:(h.w-f.w)/2,top:(h.h-f.h)/2});bigImageContent.css({width:f.w,height:f.h});bigImageContent.animate({width:u.w,height:u.h},t.options.animDuration);m.animate({left:-g.x*(u.w-h.w)+"px",top:-g.y*(u.h-h.h)+"px"},t.options.animDuration,v)}else{m.css({left:-g.x*(u.w-h.w)+"px",top:-g.y*(u.h-h.h)+"px"});v()}})};e.bind("mouseup",t["zoom"]);return t}})(jQuery);
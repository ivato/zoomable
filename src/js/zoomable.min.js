(function(e){e.fn.zoomable=function(t){if(!("forEach"in Array.prototype)){Array.prototype.forEach=function(e,t){for(var i=0,n=this.length;i<n;i++)if(i in this)e.call(t,this[i],i,this)}}var i=e(this),n=i.smallImage=i.find("img").first();i.options=e.extend({cssPrefix:"zoomable-",handleTouch:true,animated:true,animDuration:200,dblclickDelay:150,maxThumbnailSize:200,fadeOnLoad:.5,thumbnail:true},t);i.options.zoomInCursor&&n.css("cursor",i.options.zoomInCursor);if(i.options.handleTouch){var o=function(e){var t=e.changedTouches,i=t[0],n="";switch(e.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var o=document.createEvent("MouseEvent");o.initMouseEvent(n,true,true,window,1,i.screenX,i.screenY,i.clientX,i.clientY,false,false,false,false,0,null);i.target.dispatchEvent(o);e.preventDefault()};["touchstart","touchmove","touchend","touchcancel"].forEach(function(e){if(document.addEventListener){document.addEventListener(e,o,true)}else{document.attachEvent("on"+e,o)}})}i.zoomed=false;i["moveTo"]=function(e,t){if(i.bigImage){var n=t.complete;var o=t.step;t.complete=function(){i.options.thumbnail&&i.updateLens();n&&n(i)};if(i.options.thumbnail){t.step=function(){i.updateLens();o&&step(i)}}i.bigImage.animate({left:Math.max(i.cSize.w-i.sizeBig.w,Math.min(0,-e.x)),top:Math.max(i.cSize.h-i.sizeBig.h,Math.min(0,-e.y))},t)}};i["getPosition"]=function(){var e=i.bigImage?i.bigImage.position():{left:0,top:0};return{left:e.left*-1,top:e.top*-1}};i["getSize"]=function(){return i.sizeBig?{width:i.sizeBig.w,height:i.sizeBig.h}:{width:0,height:0}};i["unzoom"]=function(e){if(i.zoomed){var t=function(){i.zoomed=false;i.bigImage.unbind("mousedown").remove();i.options.thumbnail&&i.thumbnail.unbind("mousemove").unbind("mouseup").unbind("mousedown").remove();i.smallImage.css("visibility","visible");i.options.onUnzoomDidEnd&&i.options.onUnzoomDidEnd(i)};i.thumbnail.css("visibility","hidden").empty();if(i.options.animated){i.bigImageContent.animate({width:i.sizeInt.w,height:i.sizeInt.h},i.options.animDuration);i.bigImage.animate({left:(i.cSize.w-i.sizeInt.w)/2,top:(i.cSize.h-i.sizeInt.h)/2},i.options.animDuration,t)}else{t()}i.options.onUnzoomDidStart&&i.options.onUnzoomDidStart(i)}};i["zoom"]=function(t){if(i.zoomed)return;i.zoomed=true;var o=i.cSize={w:i.width(),h:i.height()},s=i.options.url,a=i.bigImage=e('<div class="'+i.options.cssPrefix+"image "+i.options.cssPrefix+'big"></div>'),h=i.thumbnail=e('<div class="'+i.options.cssPrefix+'zoomnav" ></div>');if(i.options.thumbnail)h.appendTo(i);a.appendTo(i);a.css("visibility","hidden");i.options.fadeOnLoad>=0&&n.css("opacity",i.options.fadeOnLoad);var r=t?{x:t.offsetX||t.x||t.clientX,y:t.offsetY||t.x||t.clientY}:false,m={x:0,y:0};bigImageContent=i.bigImageContent=e('<img src="'+s+'"" >'),spinner=e('<div class="'+i.options.cssPrefix+'spinner" ></div>');i.bigImageContent.appendTo(a);spinner.css({left:(o.w-spinner.width())/2,top:(o.h-spinner.height())/2}).appendTo(i);i.options.onZoomDidStart&&i.options.onZoomDidStart(i);bigImageContent.load(function(t){spinner.remove();a.css("visibility","visible");n.css({visibility:"hidden",opacity:1});var u=i.sizeBig={w:(t.srcElement||t.target).clientWidth,h:(t.srcElement||t.target).clientHeight};var c=u.w/u.h;var p=i.sizeInt=c>1?{w:o.w,h:u.h/u.w*o.w}:{w:u.w/u.h*o.h,h:o.h};if(!r)r={x:o.w/2,y:o.h/2};var d={x:Math.max(0,Math.min(1,(r.x-(o.w-p.w)/2)/p.w)),y:Math.max(0,Math.min(1,(r.y-(o.h-p.h)/2)/p.h))};a.css({width:u.w,height:u.h});var l=function(){if(i.options.thumbnail){var t=parseFloat(h.css("max-width"))||200,n=e('<img src="'+s+'"" >');n.appendTo(h);var r=e('<div class="'+i.options.cssPrefix+'lens"></div>');r.appendTo(h);t=i.options.maxThumbnailSize;var c=p.w>p.h?{w:t,h:p.h/p.w*t}:{w:p.w/p.h*t,h:t},d={w:o.w/u.w*c.w,h:o.h/u.h*c.h};n.width(c.w).height(c.h);h.css({visibility:"visible",width:c.w,height:c.h});r.css({width:d.w,height:d.h});i.updateLens=function(){var e=a.position();r.css({left:-e.left/u.w*c.w,top:-e.top/u.h*c.h})};i.updateLens();var l=function(){var e=r.position();a.css({left:-e.left*u.w/c.w,top:-e.top*u.h/c.h})};h.bind("mousedown",function(e){e.preventDefault();var t=i.offset();var n=e.pageX-t.left;var o=e.pageY-t.top;r.css({left:Math.min(c.w-d.w,Math.max(0,n-d.w/2)),top:Math.min(c.h-d.h,Math.max(0,o-d.h/2))});l();m={x:e.screenX,y:e.screenY};h.bind("mouseup",function(e){h.unbind("mousemove").unbind("mouseup");return false});h.bind("mousemove",function(e){e.preventDefault();if(e.which==0)return false;var t={x:e.screenX-m.x,y:e.screenY-m.y};m.x=e.screenX;m.y=e.screenY;var i={left:Math.min(c.w-d.w,Math.max(0,r.position().left+t.x)),top:Math.min(c.h-d.h,Math.max(0,r.position().top+t.y))};r.css(i);l();return false});return false})}a.bind("mousedown",function(e){var t=(new Date).getTime();m={x:e.screenX,y:e.screenY};i.bind("mouseup",function(e){if((new Date).getTime()-t<i.options.dblclickDelay){i.unbind("mousemove").unbind("mouseup");i["unzoom"]()}return false});i.bind("mousemove",function(e){if(e.type=="mousemove"&&e.which!=1)return false;var t={x:e.screenX-m.x,y:e.screenY-m.y};m.x=e.screenX;m.y=e.screenY;var n={left:Math.max(-u.w+o.w,Math.min(0,a.position().left+t.x)),top:Math.max(-u.h+o.h,Math.min(0,a.position().top+t.y))};a.css(n);i.options.onMove&&i.options.onMove(i);i.options.thumbnail&&i.updateLens();return false});return false})};i.options.onZoomDidEnd&&i.options.onZoomDidEnd(i);if(i.options.animated){a.css({left:(o.w-p.w)/2,top:(o.h-p.h)/2});bigImageContent.css({width:p.w,height:p.h});bigImageContent.animate({width:u.w,height:u.h},i.options.animDuration);a.animate({left:-d.x*(u.w-o.w)+"px",top:-d.y*(u.h-o.h)+"px"},i.options.animDuration,l)}else{a.css({left:-d.x*(u.w-o.w)+"px",top:-d.y*(u.h-o.h)+"px"});l()}})};n.bind("mouseup",i["zoom"]);return i}})(jQuery);